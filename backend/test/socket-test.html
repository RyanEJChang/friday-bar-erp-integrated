<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friday's Bar ERP - å³æ™‚åŒæ­¥æ¸¬è©¦</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .room-buttons { 
            margin: 20px 0; 
            text-align: center;
        }
        .room-buttons button { 
            padding: 15px 30px; 
            margin: 10px; 
            font-size: 16px; 
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: bold;
        }
        .room-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .front { background-color: #4CAF50; color: white; }
        .bar { background-color: #2196F3; color: white; }
        .admin { background-color: #FF9800; color: white; }
        
        .status-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        #messages { 
            border: 1px solid #ddd; 
            height: 400px; 
            overflow-y: scroll; 
            margin: 20px 0; 
            padding: 15px;
            background-color: #fafafa;
            border-radius: 8px;
        }
        .message { 
            margin: 8px 0; 
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #ccc;
        }
        .new-order { 
            background-color: #e3f2fd; 
            border-left-color: #2196F3;
            animation: pulse 0.5s;
        }
        .status-update { 
            background-color: #e8f5e8; 
            border-left-color: #4CAF50; 
        }
        .system { 
            background-color: #fff3e0; 
            border-left-color: #FF9800; 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .test-buttons {
            text-align: center;
            margin: 20px 0;
        }
        .test-buttons button {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
        }
        .test-buttons button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº Friday's Bar ERP - å³æ™‚åŒæ­¥æ¸¬è©¦</h1>
        
        <div class="room-buttons">
            <h3>é¸æ“‡æ‚¨çš„è§’è‰²:</h3>
            <button class="front" onclick="joinRoom('front', 'å¤–å ´å“¡å·¥å°æ˜')">
                ğŸ½ï¸ å¤–å ´äººå“¡
            </button>
            <button class="bar" onclick="joinRoom('bar', 'èª¿é…’å¸«é˜¿å¼·')">
                ğŸ¸ å…§å ´èª¿é…’å¸«
            </button>
            <button class="admin" onclick="joinRoom('admin', 'ç®¡ç†å“¡')">
                ğŸ‘‘ ç®¡ç†å“¡
            </button>
        </div>
        
        <div class="status-panel">
            <h3>é€£æ¥è³‡è¨Š</h3>
            <p><strong>é€£æ¥ç‹€æ…‹:</strong> <span id="status">æœªé€£æ¥</span></p>
            <p><strong>ç•¶å‰è§’è‰²:</strong> <span id="role">æœªé¸æ“‡</span></p>
            <p><strong>Socket ID:</strong> <span id="socketId">-</span></p>
        </div>
        
        <div id="messages"></div>
        
        <div class="test-buttons">
            <h3>æ¸¬è©¦åŠŸèƒ½:</h3>
            <button onclick="testPing()">æ¸¬è©¦é€£æ¥ (Ping)</button>
            <button onclick="simulateOrder()">æ¨¡æ“¬ä¸‹å–®</button>
            <button onclick="clearMessages()">æ¸…é™¤è¨Šæ¯</button>
        </div>
    </div>
    
    <script>
        const socket = io('http://localhost:3001', {
            transports: ['polling', 'websocket'],
            forceNew: true
        });
        
        const messages = document.getElementById('messages');
        const statusEl = document.getElementById('status');
        const roleEl = document.getElementById('role');
        const socketIdEl = document.getElementById('socketId');
        
        let currentRoom = null;
        
        // é€£æ¥äº‹ä»¶
        socket.on('connect', () => {
            statusEl.textContent = 'å·²é€£æ¥';
            statusEl.style.color = 'green';
            socketIdEl.textContent = socket.id;
            addMessage('âœ… é€£æ¥æˆåŠŸ: ' + socket.id, 'system');
        });
        
        socket.on('disconnect', () => {
            statusEl.textContent = 'å·²æ–·ç·š';
            statusEl.style.color = 'red';
            addMessage('âŒ é€£æ¥æ–·ç·š', 'system');
        });
        
        socket.on('connect_error', (error) => {
            statusEl.textContent = 'é€£æ¥éŒ¯èª¤';
            statusEl.style.color = 'red';
            addMessage('âŒ é€£æ¥éŒ¯èª¤: ' + error.message, 'system');
        });
        
        // Socket.io äº‹ä»¶
        socket.on('welcome', (data) => {
            addMessage('ğŸ‘‹ ' + data.message, 'system');
        });
        
        socket.on('joined_room', (data) => {
            currentRoom = data.room;
            roleEl.textContent = getRoomName(data.room) + ' (' + data.user + ')';
            addMessage('ğŸšª æˆåŠŸåŠ å…¥ ' + getRoomName(data.room) + ' æˆ¿é–“', 'system');
        });
        
        socket.on('new_order', (data) => {
            addMessage('ğŸ†• æ–°è¨‚å–®é€šçŸ¥: ' + data.message, 'new-order');
            if (data.sound) {
                playNotificationSound();
            }
        });
        
        socket.on('order_status_update', (data) => {
            addMessage('ğŸ“± è¨‚å–®ç‹€æ…‹æ›´æ–°: ' + data.message, 'status-update');
            if (data.sound) {
                playNotificationSound();
            }
        });
        
        socket.on('order_status_sync', (data) => {
            // ä½¿ç”¨æ›´è©³ç´°çš„è¨Šæ¯
            const detailMessage = data.message || `ğŸ”„ å…§å ´åŒæ­¥: è¨‚å–® ${data.data.id} ç‹€æ…‹æ›´æ–°`;
            addMessage(detailMessage, 'status-update');
            
            // å¦‚æœæœ‰è©³ç´°è³‡è¨Šï¼Œä¹Ÿé¡¯ç¤º
            if (data.details) {
                const detail = data.details;
                addMessage(`   â””â”€ æ¡Œè™Ÿ: ${detail.table_number}, å“é …: ${detail.item_name}, ç‹€æ…‹: ${detail.action_text}`, 'system');
            }
        });
        
        socket.on('room_stats_update', (data) => {
            addMessage('ğŸ“Š ç·šä¸Šçµ±è¨ˆ: å¤–å ´=' + data.stats.front + ', å…§å ´=' + data.stats.bar + ', ç®¡ç†=' + data.stats.admin, 'system');
        });
        
        socket.on('user_joined', (data) => {
            addMessage('ğŸ‘¤ ' + data.user + ' åŠ å…¥äº† ' + getRoomName(data.room) + ' æˆ¿é–“', 'system');
        });
        
        socket.on('user_left', (data) => {
            addMessage('ğŸ‘‹ ' + data.user + ' é›¢é–‹äº† ' + getRoomName(data.room) + ' æˆ¿é–“', 'system');
        });
        
        socket.on('pong', (data) => {
            addMessage('ğŸ“ Pong å›æ‡‰: ' + data.message, 'system');
        });
        
        // åŠŸèƒ½å‡½æ•¸
        function joinRoom(room, user) {
            socket.emit('join_room', { room: room, user: user });
            addMessage('ğŸšª å˜—è©¦åŠ å…¥ ' + getRoomName(room) + ' æˆ¿é–“...', 'system');
        }
        
        function testPing() {
            socket.emit('ping');
            addMessage('ğŸ“ ç™¼é€ Ping æ¸¬è©¦...', 'system');
        }
        
        function simulateOrder() {
            if (currentRoom !== 'front') {
                addMessage('âš ï¸ è«‹å…ˆä»¥å¤–å ´äººå“¡èº«ä»½ç™»å…¥æ‰èƒ½æ¨¡æ“¬ä¸‹å–®', 'system');
                return;
            }
            
            // æ¨¡æ“¬ API ä¸‹å–®
            fetch('http://localhost:3001/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    table_number: 'A' + Math.floor(Math.random() * 10 + 1),
                    item_name: 'ç¶“å…¸èª¿é…’-å¨å£«å¿Œå¯æ¨‚',
                    orderer: 'æ¸¬è©¦å¤–å ´å“¡å·¥'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage('âœ… æ¨¡æ“¬ä¸‹å–®æˆåŠŸ: ' + data.message, 'system');
                } else {
                    addMessage('âŒ æ¨¡æ“¬ä¸‹å–®å¤±æ•—: ' + data.message, 'system');
                }
            })
            .catch(error => {
                addMessage('âŒ ä¸‹å–®è«‹æ±‚å¤±æ•—: ' + error.message, 'system');
            });
        }
        
        function clearMessages() {
            messages.innerHTML = '';
        }
        
        function getRoomName(room) {
            const names = {
                'front': 'å¤–å ´æœå‹™',
                'bar': 'å…§å ´èª¿é…’',
                'admin': 'ç®¡ç†ä¸­å¿ƒ'
            };
            return names[room] || room;
        }
        
        function addMessage(msg, type = 'system') {
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.innerHTML = '[' + new Date().toLocaleTimeString() + '] ' + msg;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yA==');
                audio.play().catch(e => console.log('ç„¡æ³•æ’­æ”¾æç¤ºéŸ³'));
            } catch (e) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—');
            }
        }
    </script>
</body>
</html>
