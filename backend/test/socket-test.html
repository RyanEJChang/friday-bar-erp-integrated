<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friday's Bar ERP - 即時同步測試</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .room-buttons { 
            margin: 20px 0; 
            text-align: center;
        }
        .room-buttons button { 
            padding: 15px 30px; 
            margin: 10px; 
            font-size: 16px; 
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: bold;
        }
        .room-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .front { background-color: #4CAF50; color: white; }
        .bar { background-color: #2196F3; color: white; }
        .admin { background-color: #FF9800; color: white; }
        
        .status-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        #messages { 
            border: 1px solid #ddd; 
            height: 400px; 
            overflow-y: scroll; 
            margin: 20px 0; 
            padding: 15px;
            background-color: #fafafa;
            border-radius: 8px;
        }
        .message { 
            margin: 8px 0; 
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #ccc;
        }
        .new-order { 
            background-color: #e3f2fd; 
            border-left-color: #2196F3;
            animation: pulse 0.5s;
        }
        .status-update { 
            background-color: #e8f5e8; 
            border-left-color: #4CAF50; 
        }
        .system { 
            background-color: #fff3e0; 
            border-left-color: #FF9800; 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .test-buttons {
            text-align: center;
            margin: 20px 0;
        }
        .test-buttons button {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
        }
        .test-buttons button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍺 Friday's Bar ERP - 即時同步測試</h1>
        
        <div class="room-buttons">
            <h3>選擇您的角色:</h3>
            <button class="front" onclick="joinRoom('front', '外場員工小明')">
                🍽️ 外場人員
            </button>
            <button class="bar" onclick="joinRoom('bar', '調酒師阿強')">
                🍸 內場調酒師
            </button>
            <button class="admin" onclick="joinRoom('admin', '管理員')">
                👑 管理員
            </button>
        </div>
        
        <div class="status-panel">
            <h3>連接資訊</h3>
            <p><strong>連接狀態:</strong> <span id="status">未連接</span></p>
            <p><strong>當前角色:</strong> <span id="role">未選擇</span></p>
            <p><strong>Socket ID:</strong> <span id="socketId">-</span></p>
        </div>
        
        <div id="messages"></div>
        
        <div class="test-buttons">
            <h3>測試功能:</h3>
            <button onclick="testPing()">測試連接 (Ping)</button>
            <button onclick="simulateOrder()">模擬下單</button>
            <button onclick="clearMessages()">清除訊息</button>
        </div>
    </div>
    
    <script>
        const socket = io('http://localhost:3001', {
            transports: ['polling', 'websocket'],
            forceNew: true
        });
        
        const messages = document.getElementById('messages');
        const statusEl = document.getElementById('status');
        const roleEl = document.getElementById('role');
        const socketIdEl = document.getElementById('socketId');
        
        let currentRoom = null;
        
        // 連接事件
        socket.on('connect', () => {
            statusEl.textContent = '已連接';
            statusEl.style.color = 'green';
            socketIdEl.textContent = socket.id;
            addMessage('✅ 連接成功: ' + socket.id, 'system');
        });
        
        socket.on('disconnect', () => {
            statusEl.textContent = '已斷線';
            statusEl.style.color = 'red';
            addMessage('❌ 連接斷線', 'system');
        });
        
        socket.on('connect_error', (error) => {
            statusEl.textContent = '連接錯誤';
            statusEl.style.color = 'red';
            addMessage('❌ 連接錯誤: ' + error.message, 'system');
        });
        
        // Socket.io 事件
        socket.on('welcome', (data) => {
            addMessage('👋 ' + data.message, 'system');
        });
        
        socket.on('joined_room', (data) => {
            currentRoom = data.room;
            roleEl.textContent = getRoomName(data.room) + ' (' + data.user + ')';
            addMessage('🚪 成功加入 ' + getRoomName(data.room) + ' 房間', 'system');
        });
        
        socket.on('new_order', (data) => {
            addMessage('🆕 新訂單通知: ' + data.message, 'new-order');
            if (data.sound) {
                playNotificationSound();
            }
        });
        
        socket.on('order_status_update', (data) => {
            addMessage('📱 訂單狀態更新: ' + data.message, 'status-update');
            if (data.sound) {
                playNotificationSound();
            }
        });
        
        socket.on('order_status_sync', (data) => {
            // 使用更詳細的訊息
            const detailMessage = data.message || `🔄 內場同步: 訂單 ${data.data.id} 狀態更新`;
            addMessage(detailMessage, 'status-update');
            
            // 如果有詳細資訊，也顯示
            if (data.details) {
                const detail = data.details;
                addMessage(`   └─ 桌號: ${detail.table_number}, 品項: ${detail.item_name}, 狀態: ${detail.action_text}`, 'system');
            }
        });
        
        socket.on('room_stats_update', (data) => {
            addMessage('📊 線上統計: 外場=' + data.stats.front + ', 內場=' + data.stats.bar + ', 管理=' + data.stats.admin, 'system');
        });
        
        socket.on('user_joined', (data) => {
            addMessage('👤 ' + data.user + ' 加入了 ' + getRoomName(data.room) + ' 房間', 'system');
        });
        
        socket.on('user_left', (data) => {
            addMessage('👋 ' + data.user + ' 離開了 ' + getRoomName(data.room) + ' 房間', 'system');
        });
        
        socket.on('pong', (data) => {
            addMessage('🏓 Pong 回應: ' + data.message, 'system');
        });
        
        // 功能函數
        function joinRoom(room, user) {
            socket.emit('join_room', { room: room, user: user });
            addMessage('🚪 嘗試加入 ' + getRoomName(room) + ' 房間...', 'system');
        }
        
        function testPing() {
            socket.emit('ping');
            addMessage('🏓 發送 Ping 測試...', 'system');
        }
        
        function simulateOrder() {
            if (currentRoom !== 'front') {
                addMessage('⚠️ 請先以外場人員身份登入才能模擬下單', 'system');
                return;
            }
            
            // 模擬 API 下單
            fetch('http://localhost:3001/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    table_number: 'A' + Math.floor(Math.random() * 10 + 1),
                    item_name: '經典調酒-威士忌可樂',
                    orderer: '測試外場員工'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage('✅ 模擬下單成功: ' + data.message, 'system');
                } else {
                    addMessage('❌ 模擬下單失敗: ' + data.message, 'system');
                }
            })
            .catch(error => {
                addMessage('❌ 下單請求失敗: ' + error.message, 'system');
            });
        }
        
        function clearMessages() {
            messages.innerHTML = '';
        }
        
        function getRoomName(room) {
            const names = {
                'front': '外場服務',
                'bar': '內場調酒',
                'admin': '管理中心'
            };
            return names[room] || room;
        }
        
        function addMessage(msg, type = 'system') {
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.innerHTML = '[' + new Date().toLocaleTimeString() + '] ' + msg;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yqpVFApGn+DyvmASBzl+zO/aiTYHGGq+8OOdTgwOUarm7qtnHAU8k9v1yA==');
                audio.play().catch(e => console.log('無法播放提示音'));
            } catch (e) {
                console.log('音效播放失敗');
            }
        }
    </script>
</body>
</html>
